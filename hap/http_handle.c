/****************************************************************************
 *
 * MODULE:             http parse.h
 *
 * COMPONENT:          home kit interface
 *
 * REVISION:           $Revision:  1.0$
 *
 * DATED:              $Date: 2017-01-11 15:13:17 +0100 (Fri, 12 Dec 2016 $
 *
 * AUTHOR:             PCT
 *
 ****************************************************************************
 *
 * Copyright panchangtao@gmail.com 2017. All rights reserved
 *
 ***************************************************************************/
/****************************************************************************/
/***        Include files                                                 ***/
/****************************************************************************/
#include "http_handle.h"

/****************************************************************************/
/***        Macro Definitions                                             ***/
/****************************************************************************/
#define DBG_HTTP 1
/****************************************************************************/
/***        Type Definitions                                              ***/
/****************************************************************************/

/****************************************************************************/
/***        Local Function Prototypes                                     ***/
/****************************************************************************/

/****************************************************************************/
/***        Exported Variables                                            ***/
/****************************************************************************/
/****************************************************************************/
/***        Local Variables                                               ***/
/****************************************************************************/

/****************************************************************************/
/***        Exported Functions                                            ***/
/****************************************************************************/
teHttpStatus eHttpParser(char *pBuf, uint16 u16Len, tsHttpEntry *psHttpEntry)
{
    INF_vPrintln(DBG_HTTP, "--------Http Parser Package--------");
    CHECK_POINTER(psHttpEntry, E_HTTP_PARSER_ERROR);

    char *psHeader = strtok(pBuf, "\r\n");
    CHECK_POINTER(psHeader, E_HTTP_PARSER_ERROR);

    char *psHost = strtok(NULL, "\r\n");
    CHECK_POINTER(psHost, E_HTTP_PARSER_ERROR);

    char *psContentLen = strtok(NULL, "\r\n");
    CHECK_POINTER(psContentLen, E_HTTP_PARSER_ERROR);

    char *psContentType = strtok(NULL, "\r\n");
    CHECK_POINTER(psContentType, E_HTTP_PARSER_ERROR);

    char *psMethod = strtok(psHeader, " ");
    CHECK_POINTER(psMethod, E_HTTP_PARSER_ERROR);
    memcpy(psHttpEntry->acHttpMethod, psMethod, sizeof(psHttpEntry->acHttpMethod));
    char *psDirectory = strtok(NULL, " ");
    CHECK_POINTER(psDirectory, E_HTTP_PARSER_ERROR);
    memcpy(psHttpEntry->acDirectory, psDirectory, sizeof(psHttpEntry->acDirectory));
    char *psHttpVer = strtok(NULL, " ");
    CHECK_POINTER(psHttpVer, E_HTTP_PARSER_ERROR);
    memcpy(psHttpEntry->acHttpVersion, psHttpVer, sizeof(psHttpEntry->acHttpVersion));
    DBG_vPrintln(DBG_HTTP, "Method:%s,Dir:%s,Version:%s", psHttpEntry->acHttpMethod, psHttpEntry->acDirectory, psHttpEntry->acHttpVersion);

    char *psLen = strtok(psContentLen, ":");
    psLen = strtok(NULL, ":");
    CHECK_POINTER(psLen, E_HTTP_PARSER_ERROR);
    psHttpEntry->u16ContentLen = (uint16)atoi(psLen);
    DBG_vPrintln(DBG_HTTP, "Len:%d", psHttpEntry->u16ContentLen);

    char *psType = strtok(psContentType, ":");
    psType = strtok(NULL, ":");
    CHECK_POINTER(psType, E_HTTP_PARSER_ERROR);
    memcpy(psHttpEntry->acContentType, psType, sizeof(psHttpEntry->acContentType));
    DBG_vPrintln(DBG_HTTP, "Type:%s", psHttpEntry->acContentType);

    memcpy(psHttpEntry->acContentData, &pBuf[u16Len - psHttpEntry->u16ContentLen], psHttpEntry->u16ContentLen);
    if(DBG_HTTP){
        for (int i = 0; i < psHttpEntry->u16ContentLen; ++i) {
            printf("0x%02x,", psHttpEntry->acContentData[i]);
        }printf("\n");
    }
    return E_HTTP_PARSER_OK;
}

teHttpStatus eHttpResponse(int iSockFd, tsHttpEntry *psHttpEntry, uint8 *pBuffer, uint16 u16Length)
{
    INF_vPrintln(DBG_HTTP, "--------Http Send Package[%d]--------", u16Length);
    //PrintArray(DBG_HTTP, pBuffer, u16Length);
#if 1
    uint8 temp[MABF] = {0}; int index = 0;
    memcpy(&temp[index], "HTTP/1.1 ", sizeof("HTTP/1.1 ") - 1);
    index += sizeof("HTTP/1.1 ") - 1;                               PrintArray(DBG_HTTP, temp, index);
    char auHttpStatus[5] = {0};
    sprintf(auHttpStatus, "%d", psHttpEntry->iHttpStatus);
    memcpy(&temp[index], auHttpStatus, strlen(auHttpStatus));
    index += strlen(auHttpStatus);                                  PrintArray(DBG_HTTP, temp, index);
    if(200 == psHttpEntry->iHttpStatus){
        memcpy(&temp[index], " OK\r\n", sizeof(" OK\r\n") - 1);
        index += sizeof(" OK\r\n") - 1;                             PrintArray(DBG_HTTP, temp, index);
    } else {
        memcpy(&temp[index], " \r\n", sizeof(" \r\n") - 1);
        index += sizeof(" \r\n") - 1;                               PrintArray(DBG_HTTP, temp, index);
    }
    memcpy(&temp[index], "Content-Type: ", sizeof("Content-Type: ") - 1);
    index += sizeof("Content-Type: ") - 1;                          PrintArray(DBG_HTTP, temp, index);
    memcpy(&temp[index], psHttpEntry->acContentType, strlen((char*)psHttpEntry->acContentType));
    index += strlen((char*)psHttpEntry->acContentType);             PrintArray(DBG_HTTP, temp, index);
    memcpy(&temp[index], "\r\n", sizeof("\r\n") - 1);
    index += sizeof("\r\n") - 1;                                    PrintArray(DBG_HTTP, temp, index);
    memcpy(&temp[index], "Content-Length: ", sizeof("Content-Length: ") - 1);
    index += sizeof("Content-Length: ") - 1;                        PrintArray(DBG_HTTP, temp, index);
    char auHttpLen[5] = {0};
    sprintf(auHttpLen, "%d", u16Length);
    memcpy(&temp[index], auHttpLen, strlen(auHttpLen));
    index += strlen(auHttpLen);                                     PrintArray(DBG_HTTP, temp, index);
    memcpy(&temp[index], "\r\n\r\n", sizeof("\r\n\r\n") - 1);
    index += sizeof("\r\n\r\n") - 1;                                PrintArray(DBG_HTTP, temp, index);
    memcpy(&temp[index], pBuffer, u16Length);
    index += u16Length;
#else
    uint8 temp[] = {
            0x48,0x54,0x54,0x50,0x2f,0x31,0x2e,0x31,0x20,0x32,0x30,0x30,0x20,0x4f,0x4b,0x0d,0x0a,0x43,0x6f,0x6e,0x74,0x65,0x6e,0x74,0x2d,0x54,0x79,0x70,0x65,0x3a,0x20,0x61,0x70,0x70,0x6c,0x69,0x63,0x61,0x74,0x69,0x6f,0x6e,0x2f,0x70,0x61,0x69,0x72,0x69,0x6e,0x67,0x2b,0x74,0x6c,0x76,0x38,0x0d,0x0a,0x43,0x6f,0x6e,0x74,0x65,0x6e,0x74,0x2d,0x4c,0x65,0x6e,0x67,0x74,0x68,0x3a,0x20,0x34,0x31,0x32,0x0d,0x0a,0x0d,0x0a,0x06,0x01,0x02,0x03,0xff,0xe1,0x41,0x98,0x58,0xd1,0xf5,0x60,0x98,0xe4,0x35,0x5c,0xd9,0x48,0x5e,0x35,0xc0,0x48,0x2e,0xd6,0x1d,0xf3,0xcf,0xd0,0x37,0x3e,0xbf,0x0e,0x4b,0x59,0x4f,0xb2,0x2a,0x33,0x63,0x28,0x4d,0x21,0xbc,0x20,0x82,0xe9,0xa8,0x0c,0xe9,0x01,0x97,0xb5,0x94,0x78,0x0d,0xca,0xbd,0xad,0x4c,0xee,0xd4,0xdb,0x19,0x18,0xf7,0xa6,0x23,0x18,0xbc,0x49,0x83,0xe5,0xf7,0x41,0x11,0x54,0x15,0x23,0xba,0xd8,0x1f,0x12,0xbb,0x1c,0xff,0xcd,0xff,0x5a,0x01,0x13,0xfc,0xf3,0xa5,0x74,0xf7,0x70,0x9c,0x27,0x84,0xc3,0xa2,0x31,0x3d,0x3d,0x11,0x0d,0xb9,0x48,0xd6,0xdb,0xf0,0x22,0x3c,0x98,0xa1,0xee,0x6e,0xc0,0xf5,0x15,0x50,0x3c,0xf6,0xcb,0x64,0x41,0x94,0xaf,0x98,0x78,0xec,0xf3,0x39,0x3a,0x3b,0x46,0x74,0x08,0x92,0x2d,0x3d,0xeb,0xa2,0xc3,0xed,0xb2,0x9c,0x9f,0x64,0x74,0xf3,0x5a,0xf7,0x28,0xc6,0x0d,0x6e,0x02,0xba,0xc3,0xa7,0x4a,0x78,0x81,0x34,0x8a,0x12,0x34,0xbb,0x82,0x3b,0x9b,0xec,0xe2,0x69,0x27,0x63,0x70,0xf2,0x7a,0x9b,0xfa,0x87,0x14,0xa6,0x30,0x16,0xc5,0x89,0x98,0x5d,0xa2,0xa0,0x2f,0x6b,0x72,0x9f,0xee,0xc0,0xf1,0xbd,0x80,0x88,0x9c,0xfb,0xb8,0xe4,0x0d,0xd1,0xcf,0xcf,0x58,0x93,0x43,0x1b,0x00,0x69,0xfc,0xd2,0xec,0x76,0x58,0xe7,0x5c,0x3b,0x4e,0x84,0xa2,0xca,0xa7,0xa0,0x92,0x72,0xa4,0xd8,0x10,0x42,0x72,0xd9,0x54,0xf6,0x84,0x9b,0xbc,0xd7,0x76,0xb4,0x5b,0x78,0x47,0x8a,0x78,0x99,0x48,0x9d,0xa5,0x16,0x0a,0xfb,0xca,0x03,0x81,0x85,0x75,0x02,0x23,0x72,0x31,0x96,0x57,0x98,0xbd,0x98,0x45,0x59,0x16,0x93,0x69,0x95,0x5a,0x4d,0xb7,0x32,0xf3,0x2e,0xdd,0x6b,0x7a,0x67,0x1a,0x5d,0x39,0x79,0xad,0x52,0xbf,0xaf,0xfc,0xaf,0xfe,0xdc,0x6f,0x3b,0x6e,0x0d,0x9e,0x4f,0xb4,0xfb,0xbe,0x3d,0x21,0xab,0x36,0xba,0x75,0xca,0xa2,0x2c,0xe0,0xe0,0x26,0x4c,0x4d,0x00,0x3a,0xfb,0x54,0x7e,0x36,0x4f,0x73,0x21,0xa5,0xa1,0x5b,0x5b,0xc2,0x6b,0xeb,0xbd,0x0b,0xb1,0x77,0xf9,0x85,0x69,0x4f,0xca,0x7c,0x73,0xdb,0xb5,0xec,0xf6,0x09,0x11,0x37,0xf0,0x1c,0xed,0x13,0xe5,0xf3,0x61,0x02,0x5c,0xff,0x85,0x09,0x5e,0x70,0x6f,0x76,0x04,0xc7,0x24,0xba,0xd4,0x5f,0xc7,0xf1,0x8f,0xc4,0x52,0x1c,0x27,0x3b,0x8c,0x22,0x80,0x02,0x10,0x6f,0xf2,0x24,0x78,0xe6,0x69,0xc7,0x2d,0x87,0xf3,0x4a,0x28,0x82,0xea,0x5e,0x86,0x06,0x01,0x02
    };
#endif
    INF_vPrintln(DBG_HTTP, "%d", index);
    PrintArray(DBG_HTTP, temp, index);
    ssize_t ret = send(iSockFd, temp, index, 0);
    if(ret == -1){
        ERR_vPrintln(T_TRUE, "send failed:%s", strerror(errno));
    }
    //ret = send(iSockFd, pBuffer, u16Length, 0);
    //if(ret == -1){
    //    ERR_vPrintln(T_TRUE, "send failed:%s", strerror(errno));
    //}
    return E_HTTP_PARSER_OK;
}
/****************************************************************************/
/***        Local    Functions                                            ***/
/****************************************************************************/

